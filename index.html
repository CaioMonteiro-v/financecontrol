<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FinanceControl ‚Ä¢ Metas, Contas, Parcelas + IA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f18;
      --panel:#111827;
      --panel2:#0f172a;
      --line:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.65);
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --good:#22c55e;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1000px 500px at 15% 0%, rgba(124,92,255,.20), transparent 60%),
        radial-gradient(900px 450px at 85% 10%, rgba(45,212,191,.12), transparent 60%),
        var(--bg);
    }
    button,input,select,textarea{
      background:rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:rgba(232,238,252,.45)}
    button{cursor:pointer;font-weight:700}
    button:hover{border-color:rgba(255,255,255,.14)}
    .btnPrimary{background:rgba(124,92,255,.18);border-color:rgba(124,92,255,.35)}
    .btnGhost{background:transparent}
    .btnGood{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.28)}
    .btnBad{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.28)}
    .btnWarn{background:rgba(251,191,36,.10);border-color:rgba(251,191,36,.26)}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    aside{
      padding:18px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%);
    }
    .brand{
      display:flex;align-items:center;gap:12px;
      padding:14px;border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.75));
      display:grid;place-items:center;font-weight:900;
    }
    .brand h1{margin:0;font-size:16px}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}
    .nav{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .nav button{
      width:100%;text-align:left;
      display:flex;align-items:center;gap:10px;
      padding:12px 12px;border-radius:14px;
      background:rgba(255,255,255,.03);
    }
    .nav button.active{
      background:rgba(124,92,255,.16);
      border-color:rgba(124,92,255,.35);
    }
    .ico{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:rgba(232,238,252,.85);
      font-size:12px;
      flex:0 0 auto;
    }
    .sidebarBox{
      margin-top:14px;
      padding:14px;border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
    }
    .sidebarRow{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .sidebarRow b{font-size:13px}
    .sidebarRow span{font-size:12px;color:var(--muted)}
    main{padding:18px;overflow:auto}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .topLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
    }
    .pill label{font-size:12px;color:var(--muted)}
    .pill b{font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .span3{grid-column:span 3}
    .span4{grid-column:span 4}
    .span5{grid-column:span 5}
    .span6{grid-column:span 6}
    .span7{grid-column:span 7}
    .span8{grid-column:span 8}
    .span12{grid-column:span 12}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .value{font-size:24px;font-weight:900}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .muted{color:var(--muted)}
    .split{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .title{margin:0;font-size:18px;letter-spacing:-0.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    th{color:var(--muted);font-weight:700;text-align:left}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      font-size:12px;background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:rgba(232,238,252,.9);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25)}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--line)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg, rgba(124,92,255,.95), rgba(45,212,191,.85))}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row1{display:grid;grid-template-columns:1fr;gap:10px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:14px;z-index:20}
    .modalBox{
      width:100%;max-width:760px;
      border-radius:26px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:16px;
      max-height:90vh;
      overflow:auto;
    }
    .modalHeader{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modalHeader h2{margin:0;font-size:16px}
    .modalFooter{display:flex;justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      aside{display:none}
      .span3,.span4,.span5,.span6,.span7,.span8{grid-column:span 12}
    }
  </style>
</head>

<body>
<div class="app">
  <aside>
    <div class="brand">
      <div class="logo">FC</div>
      <div>
        <h1>FinanceControl</h1>
        <p>metas ‚Ä¢ sobras ‚Ä¢ parcelas ‚Ä¢ contas ‚Ä¢ IA</p>
      </div>
    </div>

    <div class="nav">
      <button class="active" onclick="setView('overview')"><span class="ico">üè†</span> Vis√£o geral</button>
      <button onclick="setView('goals')"><span class="ico">üéØ</span> Metas</button>
      <button onclick="setView('budget')"><span class="ico">üßæ</span> Or√ßamento</button>
      <button onclick="setView('fixed')"><span class="ico">üìå</span> Contas fixas</button>
      <button onclick="setView('cards')"><span class="ico">üí≥</span> Cart√£o / Fatura</button>
      <button onclick="setView('tx')"><span class="ico">üìí</span> Lan√ßamentos</button>
      <button onclick="openModal('settings')"><span class="ico">‚öôÔ∏è</span> Configura√ß√µes</button>
    </div>

    <div class="sidebarBox">
      <div class="split">
        <div>
          <div class="label">M√™s atual</div>
          <div style="font-weight:900" id="sideMonth">‚Äî</div>
        </div>
        <button class="btnPrimary" onclick="openModal('tx')">+ Lan√ßar</button>
      </div>
      <div class="sidebarRow"><b>Comprometido</b><span id="sideCommitted">‚Äî</span></div>
      <div class="sidebarRow"><b>Sobrando</b><span id="sideLeft">‚Äî</span></div>
      <div class="sidebarRow"><b>Metas</b><span id="sideGoals">‚Äî</span></div>
    </div>
  </aside>

  <main>
    <div class="topbar">
      <div class="topLeft">
        <div class="pill">
          <label>M√™s</label>
          <select id="monthSel"></select>
        </div>
        <div class="pill">
          <label>Sal√°rio</label>
          <b id="salaryLabel">‚Äî</b>
        </div>
      </div>

      <div class="actions">
        <button class="btnPrimary" onclick="openModal('tx')">+ Lan√ßamento</button>
        <button class="btnGood" onclick="openModal('goal')">+ Meta</button>
        <button class="btnGhost" onclick="openAIReport()">ü§ñ Analisar m√™s</button>
        <button class="btnWarn" onclick="closeMonth()">üîí Fechar m√™s</button>
        <button class="btnGhost" onclick="exportData()">Exportar</button>
        <button class="btnBad" onclick="resetAll()">Zerar</button>
      </div>
    </div>

    <div id="overview" class="view"></div>
    <div id="goals" class="view" style="display:none"></div>
    <div id="budget" class="view" style="display:none"></div>
    <div id="fixed" class="view" style="display:none"></div>
    <div id="cards" class="view" style="display:none"></div>
    <div id="tx" class="view" style="display:none"></div>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modalBox">
    <div class="modalHeader">
      <h2 id="modalTitle">‚Äî</h2>
      <button onclick="closeModal()">Fechar</button>
    </div>

    <!-- TX FORM -->
    <div id="formTx" style="display:none;margin-top:12px">
      <div class="row2">
        <select id="txTipo">
          <option value="entrada">Entrada</option>
          <option value="saida">Sa√≠da</option>
          <option value="cartao">Cart√£o (parcelado/√† vista)</option>
        </select>
        <select id="txMeio">
          <option>Dinheiro</option>
          <option>Pix</option>
          <option>D√©bito</option>
          <option>Cr√©dito</option>
        </select>
      </div>
      <div class="row2" style="margin-top:10px">
        <select id="txCat"></select>
        <input id="txData" type="date" />
      </div>

      <!-- FOR√áAR M√äS SELECIONADO -->
      <div class="pill" style="margin-top:10px;justify-content:space-between">
        <div style="display:flex;flex-direction:column;gap:2px">
          <b style="font-size:12px">For√ßar m√™s selecionado</b>
          <span class="muted" style="font-size:12px">O lan√ßamento sempre entra em <span id="forceMonthLabel">‚Äî</span></span>
        </div>
        <input id="txForceMonth" type="checkbox" checked style="width:18px;height:18px"/>
      </div>

      <div class="row1" style="margin-top:10px">
        <input id="txDesc" placeholder="Descri√ß√£o (ex: Mercado, Gasolina, Netflix)" />
      </div>
      <div class="row2" style="margin-top:10px">
        <input id="txValor" type="number" placeholder="Valor total (R$)" />
        <input id="txParcelas" type="number" placeholder="Parcelas (1 = √† vista)" />
      </div>
      <div class="hint">
        <b>Editar:</b> voc√™ consegue editar entradas/sa√≠das. <br/>
        <b>Cart√£o:</b> ao editar uma compra, o sistema apaga as parcelas antigas e recria com os novos dados.
      </div>
      <div class="modalFooter">
        <button onclick="closeModal()">Cancelar</button>
        <button class="btnPrimary" id="txSaveBtn" onclick="saveTx()">Salvar</button>
      </div>
    </div>

    <!-- FIXED FORM -->
    <div id="formFixed" style="display:none;margin-top:12px">
      <div class="row1">
        <input id="fxName" placeholder="Conta fixa (ex: Internet, Academia)" />
      </div>
      <div class="row2" style="margin-top:10px">
        <input id="fxValue" type="number" placeholder="Valor (R$)" />
        <select id="fxCat"></select>
      </div>
      <div class="row2" style="margin-top:10px">
        <input id="fxDay" type="number" placeholder="Dia do vencimento (ex: 10)" />
        <select id="fxActive">
          <option value="1">Ativa</option>
          <option value="0">Pausada</option>
        </select>
      </div>
      <div class="modalFooter">
        <button onclick="closeModal()">Cancelar</button>
        <button class="btnPrimary" id="fxSaveBtn" onclick="saveFixed()">Salvar</button>
      </div>
    </div>

    <!-- GOAL FORM -->
    <div id="formGoal" style="display:none;margin-top:12px">
      <div class="row1">
        <input id="goalName" placeholder="Meta (ex: PC novo, Carro, Reserva)" />
      </div>
      <div class="row2" style="margin-top:10px">
        <input id="goalTarget" type="number" placeholder="Valor alvo (R$)" />
        <input id="goalSaved" type="number" placeholder="J√° guardado (R$)" />
      </div>
      <div class="modalFooter">
        <button onclick="closeModal()">Cancelar</button>
        <button class="btnPrimary" id="goalSaveBtn" onclick="saveGoal()">Salvar</button>
      </div>
    </div>

    <!-- BUDGET FORM -->
    <div id="formBudget" style="display:none;margin-top:12px">
      <div class="row2">
        <select id="bdCat"></select>
        <input id="bdLimit" type="number" placeholder="Limite mensal (R$)" />
      </div>
      <div class="modalFooter">
        <button onclick="closeModal()">Cancelar</button>
        <button class="btnPrimary" onclick="saveBudget()">Salvar</button>
      </div>
    </div>

    <!-- SETTINGS FORM -->
    <div id="formSettings" style="display:none;margin-top:12px">
      <div class="row2">
        <input id="setSalary" type="number" placeholder="Seu sal√°rio (R$)" />
        <input id="setCats" placeholder="Categorias (separadas por v√≠rgula)" />
      </div>

      <div class="row2" style="margin-top:10px">
        <input id="setMetaMin" type="number" placeholder="Meta m√≠nima (guardar) (R$)" />
        <input id="setMetaMax" type="number" placeholder="Meta m√°xima (guardar) (R$)" />
      </div>

      <div class="hint">
        Categorias exemplo: Alimenta√ß√£o, Combust√≠vel, Lazer, Contas, Sa√∫de, Outros<br/>
        Meta (IA) √© flex√≠vel: ela recomenda Tranquilo x Forte, e voc√™ n√£o fica travado num n√∫mero fixo.
      </div>

      <div class="modalFooter">
        <button onclick="closeModal()">Cancelar</button>
        <button class="btnPrimary" onclick="saveSettings()">Salvar</button>
      </div>
    </div>

    <!-- AI REPORT -->
    <div id="formAI" style="display:none;margin-top:12px">
      <div class="card" style="box-shadow:none">
        <h3 class="title" style="margin:0">Relat√≥rio do m√™s</h3>
        <div class="sub" id="aiSub" style="margin-top:6px">‚Äî</div>

        <div class="grid" style="margin-top:12px">
          <div class="card span6" style="box-shadow:none">
            <div class="label">Dispon√≠vel real (antes de guardar)</div>
            <div class="value" id="aiDisponivel">‚Äî</div>
            <div class="sub">Sal√°rio + entradas ‚àí sa√≠das ‚àí (fixos + cart√£o)</div>
          </div>

          <div class="card span6" style="box-shadow:none">
            <div class="label">Limite seguro no cart√£o (a partir de agora)</div>
            <div class="value" id="aiLimiteCartao">‚Äî</div>
            <div class="sub">J√° desconta meta + margem</div>
          </div>

          <div class="card span6" style="box-shadow:none">
            <div class="label">Guardar (Tranquilo)</div>
            <div class="value" id="aiSaveT">‚Äî</div>
            <div class="sub" id="aiSaveTSub">‚Äî</div>
          </div>

          <div class="card span6" style="box-shadow:none">
            <div class="label">Guardar (Forte)</div>
            <div class="value" id="aiSaveF">‚Äî</div>
            <div class="sub" id="aiSaveFSub">‚Äî</div>
          </div>

          <div class="card span12" style="box-shadow:none">
            <h3 class="title" style="margin:0">Onde deu pra ‚Äúamenizar‚Äù</h3>
            <div class="sub" id="aiCuts" style="margin-top:6px">‚Äî</div>
          </div>
        </div>

        <div class="modalFooter" style="margin-top:12px">
          <button class="btnGhost" onclick="closeModal()">Fechar</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ==========================
   FinanceControl (CRUD + IA + Fechar m√™s + For√ßar m√™s selecionado)
   ========================== */
const KEY = "finance_control_crud_v2";


/* default */
const defaultState = {
  salario: 3450,
  categorias: ["Alimenta√ß√£o","Combust√≠vel","Lazer","Contas","Sa√∫de","Outros"],
  tx: [],        // {id,tipo,meio,categoria,valor,data,mes,desc}
  cartao: [],    // parcelas: {id, groupId, desc, categoria, valor, parcela, mes, dataCompra, total, parcelas}
  fixos: [],     // {id,nome,valor,categoria,dia,ativa}
  metas: [],     // {id,nome,alvo,guardado}
  orcamento: {}, // {categoria: limite}

  // IA / fechamento de m√™s
  ia: {
    metaMin: 1500,
    metaMax: 2000,
    margemSeguranca: 150,
    ultModo: "tranquilo" // tranquilo | forte
  },
  mesesFechados: {} // "YYYY-MM": {snapshot, relatorio}
};

const load = () => {
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);
    return {
      ...structuredClone(defaultState),
      ...s,
      categorias: Array.isArray(s.categorias) && s.categorias.length ? s.categorias : structuredClone(defaultState.categorias),
      orcamento: s.orcamento && typeof s.orcamento === "object" ? s.orcamento : {},
      ia: {
        ...structuredClone(defaultState.ia),
        ...(s.ia || {})
      },
      mesesFechados: (s.mesesFechados && typeof s.mesesFechados === "object") ? s.mesesFechados : {}
    };
  }catch{
    return structuredClone(defaultState);
  }
};
let state = load();
const save = () => localStorage.setItem(KEY, JSON.stringify(state));

/* Utils */
const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random().toString(16).slice(2));
const pad2 = (n) => String(n).padStart(2,"0");
const monthNow = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
};
const ymFromDate = (d) => d ? d.slice(0,7) : "";
const normalizeYM = (ym) => {
  if(!ym) return "";
  const [y,m] = String(ym).split("-");
  if(!y || !m) return ym;
  return `${y}-${pad2(m)}`;
};
const monthLabel = (ym) => {
  const [y,m] = ym.split("-");
  return `${m}/${y}`;
};
const money = (v) => (Number(v||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const sum = (arr, key="valor") => arr.reduce((a,b)=>a+Number(b[key]||0),0);
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function defaultDateForMonth(ym){
  // retorna YYYY-MM-DD dentro do m√™s selecionado, usando o dia de hoje (ou √∫ltimo dia do m√™s)
  const today = new Date();
  const [y,m] = ym.split("-");
  const day = today.getDate();
  const lastDay = new Date(Number(y), Number(m), 0).getDate();
  const safeDay = Math.min(day, lastDay);
  return `${y}-${pad2(m)}-${pad2(safeDay)}`;
}

function forceDateToSelectedMonth(dateStr, selectedYM){
  if(!dateStr || !selectedYM) return dateStr;
  const [y,m] = selectedYM.split("-");
  const d = (dateStr.split("-")[2] || "01");
  const day = Number(d || 1);
  const lastDay = new Date(Number(y), Number(m), 0).getDate();
  const safeDay = String(Math.min(day, lastDay)).padStart(2,"0");
  return `${y}-${pad2(m)}-${safeDay}`;
}

/* Month selection */
let selectedMonth = localStorage.getItem(KEY+"_month") || monthNow();
localStorage.setItem(KEY+"_month", selectedMonth);

/* Views */
let view = "overview";
function setView(v){
  view = v;
  document.querySelectorAll(".view").forEach(x=>x.style.display="none");
  document.getElementById(v).style.display="block";
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const btn = Array.from(document.querySelectorAll(".nav button")).find(b => (b.getAttribute("onclick")||"").includes(v));
  if(btn) btn.classList.add("active");
  render();
}

/* Data by month */
function getMonthOptions(){
  const set = new Set([monthNow()]);
  state.tx.forEach(t=> set.add(t.mes || ymFromDate(t.data)));
  state.cartao.forEach(p=> set.add(normalizeYM(p.mes)));
  Object.keys(state.mesesFechados || {}).forEach(m=> set.add(m));

  return Array.from(set)
    .filter(Boolean)
    .map(normalizeYM)
    .filter(m => m !== "2025-12") // ‚úÖ remove Dezembro/2025 do seletor
    .sort();
}
}
function monthTx(ym){ return state.tx.filter(t => (t.mes || ymFromDate(t.data)) === ym); }
function monthCard(ym){ return state.cartao.filter(p => normalizeYM(p.mes) === ym); }
function monthFixed(){ return state.fixos.filter(f => f.ativa); }

function totalsForMonth(ym){
  const tx = monthTx(ym);
  const card = monthCard(ym);
  const fix = monthFixed();

  const entradas = sum(tx.filter(t=>t.tipo==="entrada"));
  const saidas = sum(tx.filter(t=>t.tipo==="saida"));
  const fixosTotal = sum(fix);
  const cartaoTotal = sum(card);

  const comprometido = fixosTotal + cartaoTotal;
  const sobrando = Number(state.salario) + entradas - saidas - comprometido;

  return {tx, card, fix, entradas, saidas, fixosTotal, cartaoTotal, comprometido, sobrando};
}

function spendingByCategory(ym){
  const {tx, card, fix} = totalsForMonth(ym);
  const map = {};
  const add = (cat,v)=>{ const c = cat || "Outros"; map[c]=(map[c]||0)+Number(v||0); };
  tx.filter(t=>t.tipo==="saida").forEach(t=> add(t.categoria,t.valor));
  fix.forEach(f=> add(f.categoria,f.valor));
  card.forEach(p=> add(p.categoria,p.valor));
  state.categorias.forEach(c=>{ if(map[c]==null) map[c]=0; });
  return map;
}

/* ===== Modal ===== */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");

const formTx = document.getElementById("formTx");
const formFixed = document.getElementById("formFixed");
const formGoal = document.getElementById("formGoal");
const formBudget = document.getElementById("formBudget");
const formSettings = document.getElementById("formSettings");
const formAI = document.getElementById("formAI");

let modalMode = null;

// edi√ß√£o
let editTxId = null;          // tx normal
let editFixedId = null;
let editGoalId = null;
let editCardGroupId = null;   // compra no cart√£o (grupo)

function hideAllForms(){
  [formTx,formFixed,formGoal,formBudget,formSettings,formAI].forEach(f=>f.style.display="none");
}

function fillCats(selectId, defaultValue=null){
  const sel = document.getElementById(selectId);
  sel.innerHTML = state.categorias.map(c=>`<option>${c}</option>`).join("");
  if(defaultValue && state.categorias.includes(defaultValue)) sel.value = defaultValue;
}

function openModal(mode, payload=null){
  modalMode = mode;
  hideAllForms();

  // reset ids
  editTxId = null; editFixedId = null; editGoalId = null; editCardGroupId = null;

  if(mode==="tx"){
    modalTitle.textContent = payload?.title || "Novo lan√ßamento";
    formTx.style.display="block";
    fillCats("txCat", payload?.categoria || "Outros");

    // For√ßar m√™s: ON por padr√£o
    document.getElementById("txForceMonth").checked = true;
    document.getElementById("forceMonthLabel").textContent = monthLabel(selectedMonth);

    // campos
    document.getElementById("txTipo").value = payload?.tipo || "saida";
    document.getElementById("txMeio").value = payload?.meio || "Pix";

    // data: se n√£o vier payload.data, usa dia de hoje dentro do m√™s selecionado
    document.getElementById("txData").value = payload?.data || defaultDateForMonth(selectedMonth);

    document.getElementById("txDesc").value = payload?.desc || "";
    document.getElementById("txValor").value = payload?.valor ?? "";
    document.getElementById("txParcelas").value = payload?.parcelas ?? 1;

    // botao
    document.getElementById("txSaveBtn").textContent = payload?.isEdit ? "Salvar altera√ß√µes" : "Salvar";

    // ids de edi√ß√£o
    if(payload?.editTxId) editTxId = payload.editTxId;
    if(payload?.editCardGroupId) editCardGroupId = payload.editCardGroupId;
  }

  if(mode==="fixed"){
    modalTitle.textContent = payload?.title || "Conta fixa";
    formFixed.style.display="block";
    fillCats("fxCat", payload?.categoria || "Contas");

    document.getElementById("fxName").value = payload?.nome || "";
    document.getElementById("fxValue").value = payload?.valor ?? "";
    document.getElementById("fxDay").value = payload?.dia ?? 10;
    document.getElementById("fxActive").value = payload?.ativa ? "1" : "0";
    document.getElementById("fxSaveBtn").textContent = payload?.isEdit ? "Salvar altera√ß√µes" : "Salvar";
    if(payload?.editFixedId) editFixedId = payload.editFixedId;
  }

  if(mode==="goal"){
    modalTitle.textContent = payload?.title || "Meta";
    formGoal.style.display="block";
    document.getElementById("goalName").value = payload?.nome || "";
    document.getElementById("goalTarget").value = payload?.alvo ?? "";
    document.getElementById("goalSaved").value = payload?.guardado ?? 0;
    document.getElementById("goalSaveBtn").textContent = payload?.isEdit ? "Salvar altera√ß√µes" : "Salvar";
    if(payload?.editGoalId) editGoalId = payload.editGoalId;
  }

  if(mode==="budget"){
    modalTitle.textContent = "Limite por categoria";
    formBudget.style.display="block";
    fillCats("bdCat");
    document.getElementById("bdLimit").value = "";
  }

  if(mode==="settings"){
    modalTitle.textContent = "Configura√ß√µes";
    formSettings.style.display="block";
    document.getElementById("setSalary").value = state.salario;
    document.getElementById("setCats").value = state.categorias.join(", ");
    document.getElementById("setMetaMin").value = state.ia?.metaMin ?? 1500;
    document.getElementById("setMetaMax").value = state.ia?.metaMax ?? 2000;
  }

  modal.style.display="flex";
}

function closeModal(){
  modal.style.display="none";
  modalMode = null;
  editTxId = null; editFixedId = null; editGoalId = null; editCardGroupId = null;
}

/* ===== Save handlers ===== */
function saveTx(){
  const tipo = document.getElementById("txTipo").value;
  const meio = document.getElementById("txMeio").value;
  const categoria = document.getElementById("txCat").value;
  const data = document.getElementById("txData").value;
  const desc = document.getElementById("txDesc").value.trim();
  const valor = Number(document.getElementById("txValor").value);
  const parcelas = Math.max(1, Math.floor(Number(document.getElementById("txParcelas").value || 1)));

  if(!data || !desc || !valor || valor<=0){
    alert("Preencha data, descri√ß√£o e valor.");
    return;
  }

  // For√ßar m√™s selecionado (padr√£o ON)
  const force = document.getElementById("txForceMonth")?.checked;
  let finalData = data;
  if(force){
    finalData = forceDateToSelectedMonth(data, selectedMonth);
  }

  // EDIT TX NORMAL (entrada/saida)
  if(editTxId && tipo !== "cartao"){
    const t = state.tx.find(x=>x.id===editTxId);
    if(!t){ alert("N√£o encontrei esse lan√ßamento pra editar."); return; }
    t.tipo = tipo;
    t.meio = meio;
    t.categoria = categoria;
    t.data = finalData;
    t.mes = ymFromDate(finalData);
    t.desc = desc;
    t.valor = valor;
    save(); closeModal(); render(); return;
  }

  // EDIT COMPRA NO CART√ÉO (grupo)
  if(editCardGroupId && tipo === "cartao"){
    state.cartao = state.cartao.filter(p=>p.groupId !== editCardGroupId);
    createCardPurchase({
      groupId: editCardGroupId,
      desc, categoria, dataCompra: finalData, total: valor, parcelas
    });
    save(); closeModal(); render(); return;
  }

  // CRIAR NOVO
  if(tipo === "cartao"){
    createCardPurchase({
      groupId: uid(),
      desc, categoria, dataCompra: finalData, total: valor, parcelas
    });
  } else {
    state.tx.push({
      id: uid(),
      tipo, meio, categoria,
      valor,
      data: finalData,
      mes: ymFromDate(finalData),
      desc
    });
  }

  save(); closeModal(); render();
}

function createCardPurchase({groupId, desc, categoria, dataCompra, total, parcelas}){
  const per = total / parcelas;
  const start = new Date(dataCompra);

  for(let i=0;i<parcelas;i++){
    const dt = new Date(start);
    dt.setMonth(dt.getMonth()+i);
    const mes = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;

    state.cartao.push({
      id: uid(),
      groupId,
      desc,
      categoria,
      valor: Number(per.toFixed(2)),
      parcela: `${i+1}/${parcelas}`,
      mes,
      dataCompra,
      total,
      parcelas
    });
  }
}

function saveFixed(){
  const nome = document.getElementById("fxName").value.trim();
  const valor = Number(document.getElementById("fxValue").value);
  const categoria = document.getElementById("fxCat").value;
  const dia = Math.max(1, Math.min(31, Math.floor(Number(document.getElementById("fxDay").value || 10))));
  const ativa = document.getElementById("fxActive").value === "1";

  if(!nome || !valor || valor<=0){
    alert("Preencha nome e valor.");
    return;
  }

  if(editFixedId){
    const f = state.fixos.find(x=>x.id===editFixedId);
    if(!f){ alert("N√£o encontrei essa conta fixa pra editar."); return; }
    f.nome = nome; f.valor = valor; f.categoria = categoria; f.dia = dia; f.ativa = ativa;
    save(); closeModal(); render(); return;
  }

  state.fixos.push({id: uid(), nome, valor, categoria, dia, ativa});
  save(); closeModal(); render();
}

function saveGoal(){
  const nome = document.getElementById("goalName").value.trim();
  const alvo = Number(document.getElementById("goalTarget").value);
  const guardado = Number(document.getElementById("goalSaved").value || 0);

  if(!nome || !alvo || alvo<=0){
    alert("Preencha nome e valor alvo.");
    return;
  }

  if(editGoalId){
    const g = state.metas.find(x=>x.id===editGoalId);
    if(!g){ alert("N√£o encontrei essa meta pra editar."); return; }
    g.nome = nome; g.alvo = alvo; g.guardado = guardado;
    save(); closeModal(); render(); return;
  }

  state.metas.push({id: uid(), nome, alvo, guardado});
  save(); closeModal(); render();
}

function saveBudget(){
  const cat = document.getElementById("bdCat").value;
  const limit = Number(document.getElementById("bdLimit").value);
  if(!limit || limit<=0){ alert("Informe um limite v√°lido."); return; }
  state.orcamento[cat] = limit;
  save(); closeModal(); render();
}

function saveSettings(){
  const sal = Number(document.getElementById("setSalary").value);
  const cats = document.getElementById("setCats").value
    .split(",").map(s=>s.trim()).filter(Boolean);

  const metaMin = Number(document.getElementById("setMetaMin").value || 1500);
  const metaMax = Number(document.getElementById("setMetaMax").value || 2000);

  if(!sal || sal<=0){ alert("Sal√°rio inv√°lido."); return; }
  if(!cats.length){ alert("Informe pelo menos 1 categoria."); return; }
  if(!metaMin || metaMin<0 || !metaMax || metaMax<metaMin){ alert("Meta min/max inv√°lida."); return; }

  state.salario = sal;
  state.categorias = cats;

  // IA
  state.ia.metaMin = metaMin;
  state.ia.metaMax = metaMax;

  // limpa or√ßamento de categorias removidas
  const newBudget = {};
  for(const c of cats) if(state.orcamento[c]) newBudget[c]=state.orcamento[c];
  state.orcamento = newBudget;

  save(); closeModal(); render();
}

/* ===== Edit / Delete actions ===== */
function editTx(id){
  const t = state.tx.find(x=>x.id===id);
  if(!t) return;
  openModal("tx", {
    title: "Editar lan√ßamento",
    isEdit: true,
    editTxId: t.id,
    tipo: t.tipo,
    meio: t.meio,
    categoria: t.categoria,
    data: t.data,
    desc: t.desc,
    valor: t.valor,
    parcelas: 1
  });
}
function delTx(id){
  if(!confirm("Excluir este lan√ßamento?")) return;
  state.tx = state.tx.filter(t=>t.id!==id);
  save(); render();
}

function editFixed(id){
  const f = state.fixos.find(x=>x.id===id);
  if(!f) return;
  openModal("fixed", {
    title: "Editar conta fixa",
    isEdit: true,
    editFixedId: f.id,
    nome: f.nome,
    valor: f.valor,
    categoria: f.categoria,
    dia: f.dia,
    ativa: f.ativa
  });
}
function delFixed(id){
  if(!confirm("Excluir esta conta fixa?")) return;
  state.fixos = state.fixos.filter(f=>f.id!==id);
  save(); render();
}
function toggleFixed(id){
  const f = state.fixos.find(x=>x.id===id);
  if(!f) return;
  f.ativa = !f.ativa;
  save(); render();
}

function editGoal(id){
  const g = state.metas.find(x=>x.id===id);
  if(!g) return;
  openModal("goal", {
    title: "Editar meta",
    isEdit: true,
    editGoalId: g.id,
    nome: g.nome,
    alvo: g.alvo,
    guardado: g.guardado
  });
}
function delGoal(id){
  if(!confirm("Excluir esta meta?")) return;
  state.metas = state.metas.filter(g=>g.id!==id);
  save(); render();
}
function addToGoal(id){
  const g = state.metas.find(x=>x.id===id);
  if(!g) return;
  const v = Number(prompt(`Aporte para "${g.nome}" (R$):`, "100"));
  if(!v || v<=0) return;
  g.guardado = Number((Number(g.guardado||0) + v).toFixed(2));
  save(); render();
}

function getCardGroupsForMonth(ym){
  const list = monthCard(ym);
  const map = {};
  for(const p of list){
    if(!map[p.groupId]) map[p.groupId]=[];
    map[p.groupId].push(p);
  }
  const groups = Object.entries(map).map(([groupId, arr])=>{
    const sample = arr[0];
    return {
      groupId,
      desc: sample.desc,
      categoria: sample.categoria,
      dataCompra: sample.dataCompra,
      total: sample.total,
      parcelas: sample.parcelas,
      parcelasNoMes: arr
    };
  });
  return groups;
}

function editCardPurchase(groupId){
  const any = state.cartao.find(p=>p.groupId===groupId);
  if(!any) return;
  openModal("tx", {
    title: "Editar compra no cart√£o",
    isEdit: true,
    editCardGroupId: groupId,
    tipo: "cartao",
    meio: "Cr√©dito",
    categoria: any.categoria || "Outros",
    data: any.dataCompra || defaultDateForMonth(selectedMonth),
    desc: any.desc || "",
    valor: any.total || (Number(any.valor||0) * Number(any.parcelas||1)),
    parcelas: any.parcelas || 1
  });
  document.getElementById("txTipo").value = "cartao";
}

function delCardPurchase(groupId){
  if(!confirm("Excluir a compra do cart√£o (todas as parcelas)?")) return;
  state.cartao = state.cartao.filter(p=>p.groupId!==groupId);
  save(); render();
}

/* ===== Export / Reset ===== */
function exportData(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "financecontrol_backup.json";
  a.click();
  URL.revokeObjectURL(url);
}
function resetAll(){
  if(!confirm("Tem certeza que quer zerar tudo?")) return;
  localStorage.removeItem(KEY);
  localStorage.removeItem(KEY+"_month");
  state = load();
  selectedMonth = monthNow();
  localStorage.setItem(KEY+"_month", selectedMonth);
  render();
}

/* ==========================
   IA + Fechar m√™s
   ========================== */
function isMonthClosed(ym){
  return !!state.mesesFechados?.[ym];
}

function getMonthBase(ym){
  if(isMonthClosed(ym)){
    return state.mesesFechados[ym].snapshot;
  }
  const t = totalsForMonth(ym);
  const spend = spendingByCategory(ym);
  return {
    ym,
    salario: Number(state.salario||0),
    entradas: t.entradas,
    saidas: t.saidas,
    fixosTotal: t.fixosTotal,
    cartaoTotal: t.cartaoTotal,
    comprometido: t.comprometido,
    sobrando: t.sobrando,
    spendByCat: spend
  };
}

function avgByCategory(lastN = 3){
  const months = getMonthOptions().slice(-lastN);
  const map = {};
  const count = {};

  for(const ym of months){
    const base = getMonthBase(ym);
    const spend = base.spendByCat || {};
    for(const [cat,val] of Object.entries(spend)){
      map[cat] = (map[cat]||0) + Number(val||0);
      count[cat] = (count[cat]||0) + 1;
    }
  }
  const avg = {};
  for(const cat of Object.keys(map)){
    avg[cat] = map[cat] / (count[cat]||1);
  }
  state.categorias.forEach(c=>{ if(avg[c]==null) avg[c]=0; });
  return avg;
}

function aiCompute(ym){
  const base = getMonthBase(ym);

  const disponivel = Number(base.sobrando || 0);
  const metaMin = Number(state.ia?.metaMin ?? 1500);
  const metaMax = Number(state.ia?.metaMax ?? 2000);
  const margem = Number(state.ia?.margemSeguranca ?? 150);

  // recomenda√ß√£o flex√≠vel (Tranquilo / Forte) baseada no que sobrou
  const tRaw = Math.round(disponivel * 0.45);
  const fRaw = Math.round(disponivel * 0.65);

  const guardarTranquilo = clamp(tRaw, 0, disponivel);
  const guardarForte = clamp(fRaw, 0, disponivel);

  // puxa pro range quando der, sem travar quando n√£o der
  const tranquilo = (disponivel >= metaMin) ? clamp(guardarTranquilo, metaMin, Math.min(disponivel, metaMax)) : guardarTranquilo;
  const forte = (disponivel >= metaMax) ? metaMax : clamp(Math.max(tranquilo, guardarForte), 0, disponivel);

  const modo = state.ia?.ultModo || "tranquilo";
  const chosen = modo === "forte" ? forte : tranquilo;
  const limiteSeguroCartao = Math.max(0, disponivel - chosen - margem);

  // vazamentos: acima do limite ou acima da m√©dia (√∫ltimos 3 meses)
  const spend = base.spendByCat || {};
  const avg = avgByCategory(3);

  const cuts = [];
  for(const cat of state.categorias){
    const gasto = Number(spend[cat]||0);
    const lim = Number(state.orcamento?.[cat]||0);
    const media = Number(avg[cat]||0);

    if(lim > 0 && gasto > lim){
      cuts.push({cat, motivo:"acima do limite", excesso: gasto - lim});
      continue;
    }
    const diff = gasto - media;
    if(diff > 80){
      cuts.push({cat, motivo:"acima da m√©dia", excesso: diff});
    }
  }
  cuts.sort((a,b)=>b.excesso-a.excesso);

  return {
    ym, base, disponivel,
    tranquilo, forte,
    limiteSeguroCartao, margem,
    cuts: cuts.slice(0,3),
    metaMin, metaMax
  };
}

function aiText(rel){
  const {disponivel, tranquilo, forte, limiteSeguroCartao, cuts, metaMin, metaMax} = rel;

  const status = disponivel < 0
    ? "‚ö†Ô∏è Voc√™ fechou o m√™s no negativo. Ajuste cart√£o/fixos/sa√≠das."
    : "‚úÖ M√™s ok. Agora √© escolher o ritmo e guardar bem.";

  const tSub = disponivel >= metaMin
    ? `Dentro da sua meta flex√≠vel (${money(metaMin)}‚Äì${money(metaMax)}), sem sufocar.`
    : `Este m√™s n√£o deu pra bater a meta desejada, ent√£o o ‚ÄúTranquilo‚Äù fica no realista.`;

  const fSub = disponivel >= metaMax
    ? `Acelera suas metas com for√ßa (sem quebrar).`
    : `Forte fica limitado pelo que realmente sobrou.`;

  let cutsTxt = "Sem grandes vazamentos detectados. Continue assim.";
  if(cuts.length){
    cutsTxt = cuts.map(c=>`‚Ä¢ ${c.cat}: ${c.motivo} (amenizar ~${money(c.excesso)} j√° ajuda).`).join("<br/>");
  }

  return {status, tSub, fSub, cutsTxt};
}

function openAIReport(){
  const rel = aiCompute(selectedMonth);
  const txt = aiText(rel);

  modalTitle.textContent = `ü§ñ Assistente ‚Ä¢ ${monthLabel(selectedMonth)} ${isMonthClosed(selectedMonth) ? "(Fechado)" : "(Aberto)"}`;
  hideAllForms();
  formAI.style.display = "block";

  document.getElementById("aiSub").innerHTML = txt.status;

  document.getElementById("aiDisponivel").innerHTML =
    `<span class="${rel.disponivel>=0?'good':'bad'}">${money(rel.disponivel)}</span>`;

  document.getElementById("aiLimiteCartao").innerHTML =
    `<span class="${rel.limiteSeguroCartao>0?'good':'warn'}">${money(rel.limiteSeguroCartao)}</span>`;

  document.getElementById("aiSaveT").innerHTML = `<span class="good">${money(rel.tranquilo)}</span>`;
  document.getElementById("aiSaveF").innerHTML = `<span class="good">${money(rel.forte)}</span>`;
  document.getElementById("aiSaveTSub").innerHTML = txt.tSub;
  document.getElementById("aiSaveFSub").innerHTML = txt.fSub;

  document.getElementById("aiCuts").innerHTML = txt.cutsTxt;

  modal.style.display = "flex";
}

function closeMonth(){
  const ym = selectedMonth;

  if(isMonthClosed(ym)){
    alert("Esse m√™s j√° est√° fechado.");
    return;
  }
  if(!confirm(`Fechar o m√™s ${monthLabel(ym)}? Isso cria um hist√≥rico fixo.`)) return;

  const rel = aiCompute(ym);
  const txt = aiText(rel);

  if(!state.mesesFechados) state.mesesFechados = {};

  state.mesesFechados[ym] = {
    closedAt: new Date().toISOString(),
    snapshot: {
      ym,
      salario: Number(state.salario||0),
      entradas: rel.base.entradas,
      saidas: rel.base.saidas,
      fixosTotal: rel.base.fixosTotal,
      cartaoTotal: rel.base.cartaoTotal,
      comprometido: rel.base.comprometido,
      sobrando: rel.base.sobrando,
      spendByCat: rel.base.spendByCat
    },
    relatorio: {
      disponivel: rel.disponivel,
      tranquilo: rel.tranquilo,
      forte: rel.forte,
      limiteSeguroCartao: rel.limiteSeguroCartao,
      metaMin: rel.metaMin,
      metaMax: rel.metaMax,
      margem: rel.margem,
      cuts: rel.cuts,
      texto: txt
    }
  };

  save();
  render();
  openAIReport();
}

/* ===== Render ===== */
function renderTop(){
  const months = getMonthOptions();
  if(!months.includes(selectedMonth)){
    selectedMonth = months[months.length-1] || monthNow();
    localStorage.setItem(KEY+"_month", selectedMonth);
  }

  const sel = document.getElementById("monthSel");
  sel.innerHTML = months.map(m=>`<option value="${m}" ${m===selectedMonth?"selected":""}>${monthLabel(m)}</option>`).join("");
  sel.onchange = (e)=>{
    selectedMonth = e.target.value;
    localStorage.setItem(KEY+"_month", selectedMonth);

    // atualizar label do "for√ßar m√™s" se o modal estiver aberto
    const lbl = document.getElementById("forceMonthLabel");
    if(lbl) lbl.textContent = monthLabel(selectedMonth);

    render();
  };

  document.getElementById("salaryLabel").textContent = money(state.salario);

  const t = totalsForMonth(selectedMonth);
  const totalTargets = sum(state.metas,"alvo");
  const totalSaved = sum(state.metas,"guardado");

  document.getElementById("sideMonth").textContent = monthLabel(selectedMonth);
  document.getElementById("sideCommitted").textContent = money(t.comprometido);
  document.getElementById("sideLeft").textContent = money(t.sobrando);
  document.getElementById("sideGoals").textContent = `${money(totalSaved)} / ${money(totalTargets)}`;
}

function estimateMonths(goal, monthlyCap){
  const remain = Math.max(0, Number(goal.alvo) - Number(goal.guardado||0));
  if(remain<=0) return 0;
  if(monthlyCap<=0) return null;
  return Math.ceil(remain / monthlyCap);
}

function renderOverview(){
  const t = totalsForMonth(selectedMonth);
  const spend = spendingByCategory(selectedMonth);
  const cap = Math.max(0, t.sobrando);

  const entries = Object.entries(spend).sort((a,b)=>b[1]-a[1]).slice(0,6);

  // dica simples
  let tip = "Cadastre metas (PC/carro/reserva) pra o sistema calcular o prazo.";
  if(state.metas.length){
    const g = state.metas[0];
    const m = estimateMonths(g, cap);
    if(m === 0) tip = `Meta "${g.nome}" conclu√≠da.`;
    else if(m == null) tip = `Sem sobra no m√™s agora. Ajuste or√ßamento/contas/cart√£o.`;
    else tip = `No ritmo atual, voc√™ conclui "${g.nome}" em ~${m} m√™s(es).`;
  }

  const rel = aiCompute(selectedMonth);
  const txt = aiText(rel);
  const fechado = isMonthClosed(selectedMonth);

  overview.innerHTML = `
    <div class="grid">
      <div class="card span3">
        <div class="label">Sobrando no m√™s</div>
        <div class="value ${t.sobrando>=0?"good":"bad"}">${money(t.sobrando)}</div>
        <div class="sub">Sal√°rio + entradas ‚àí sa√≠das ‚àí (fixos + cart√£o)</div>
      </div>

      <div class="card span3">
        <div class="label">Comprometido</div>
        <div class="value bad">${money(t.comprometido)}</div>
        <div class="sub">Fixos: ${money(t.fixosTotal)} ‚Ä¢ Cart√£o: ${money(t.cartaoTotal)}</div>
      </div>

      <div class="card span3">
        <div class="label">Entradas</div>
        <div class="value good">${money(t.entradas)}</div>
        <div class="sub">Somente lan√ßamentos do m√™s</div>
      </div>

      <div class="card span3">
        <div class="label">Sa√≠das</div>
        <div class="value bad">${money(t.saidas)}</div>
        <div class="sub">Sem contar fixos e cart√£o</div>
      </div>

      <div class="card span7">
        <div class="split">
          <div>
            <h3 class="title">Gastos por categoria</h3>
            <div class="sub">Inclui sa√≠das + fixos + parcelas do cart√£o</div>
          </div>
          <button class="btnWarn" onclick="openModal('budget')">Definir limites</button>
        </div>

        <table style="margin-top:10px">
          <tr><th>Categoria</th><th>Gasto</th><th>Limite</th><th>Status</th></tr>
          ${entries.map(([cat,val])=>{
            const lim = Number(state.orcamento?.[cat]||0);
            const pct = lim>0 ? (val/lim) : null;
            const status = lim>0
              ? (pct>=1 ? `<span class="tag"><span class="dot" style="background:var(--bad)"></span> Estourou</span>`
                : pct>=0.8 ? `<span class="tag"><span class="dot" style="background:var(--warn)"></span> Aten√ß√£o</span>`
                : `<span class="tag"><span class="dot" style="background:var(--good)"></span> Ok</span>`)
              : `<span class="tag">sem limite</span>`;
            return `
              <tr>
                <td>${cat}</td>
                <td class="bad">${money(val)}</td>
                <td>${lim>0?money(lim):"‚Äî"}</td>
                <td>${status}</td>
              </tr>
            `;
          }).join("")}
        </table>
      </div>

      <div class="card span5">
        <h3 class="title">Leitura r√°pida</h3>
        <div class="sub" style="margin-top:6px">${tip}</div>
        <div style="margin-top:12px" class="split">
          <button class="btnGood" onclick="openModal('goal')">+ Meta</button>
          <button onclick="openModal('fixed')">+ Conta fixa</button>
        </div>
      </div>

      <!-- IA CARD -->
      <div class="card span12">
        <div class="split">
          <div>
            <h3 class="title" style="margin:0">ü§ñ Assistente Financeiro ${fechado ? "‚Ä¢ (M√™s fechado)" : ""}</h3>
            <div class="sub" style="margin-top:6px">${txt.status}</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btnGhost" onclick="openAIReport()">Analisar m√™s</button>
            ${fechado ? "" : `<button class="btnWarn" onclick="closeMonth()">Fechar m√™s</button>`}
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div class="card span4" style="box-shadow:none">
            <div class="label">Dispon√≠vel real (antes de guardar)</div>
            <div class="value ${rel.disponivel>=0?'good':'bad'}">${money(rel.disponivel)}</div>
          </div>

          <div class="card span4" style="box-shadow:none">
            <div class="label">Guardar (Tranquilo)</div>
            <div class="value good">${money(rel.tranquilo)}</div>
            <div class="sub">${txt.tSub}</div>
          </div>

          <div class="card span4" style="box-shadow:none">
            <div class="label">Limite seguro no cart√£o</div>
            <div class="value ${rel.limiteSeguroCartao>0?'good':'warn'}">${money(rel.limiteSeguroCartao)}</div>
            <div class="sub">Considera meta + margem</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderGoals(){
  const t = totalsForMonth(selectedMonth);
  const cap = Math.max(0, t.sobrando);

  goals.innerHTML = `
    <div class="split" style="margin-bottom:12px">
      <div>
        <h2 class="title" style="margin:0">Metas</h2>
        <div class="sub">Aportes + previs√£o com base no seu ‚Äúsobrando‚Äù do m√™s.</div>
      </div>
      <button class="btnGood" onclick="openModal('goal')">+ Nova meta</button>
    </div>

    <div class="grid">
      ${state.metas.map(g=>{
        const pct = Math.min(100, Math.round((Number(g.guardado||0) / Number(g.alvo||1))*100));
        const remain = Math.max(0, Number(g.alvo) - Number(g.guardado||0));
        const months = estimateMonths(g, cap);
        const when = months===0 ? "Conclu√≠da" : (months==null ? "Sem previs√£o" : `~${months} m√™s(es)`);
        return `
          <div class="card span6">
            <div class="split">
              <div>
                <div class="label">${g.nome}</div>
                <div class="value" style="font-size:18px">${money(g.guardado)} <span class="muted">/ ${money(g.alvo)}</span></div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <button class="btnGood" onclick="addToGoal('${g.id}')">+ Aporte</button>
                <button onclick="editGoal('${g.id}')">Editar</button>
                <button class="btnBad" onclick="delGoal('${g.id}')">Excluir</button>
              </div>
            </div>
            <div class="progress" style="margin-top:12px"><div class="bar" style="width:${pct}%"></div></div>
            <div class="split" style="margin-top:10px">
              <span class="tag">${pct}% ‚Ä¢ Falta ${money(remain)}</span>
              <span class="tag">Previs√£o: ${when}</span>
            </div>
          </div>
        `;
      }).join("") || `
        <div class="card span12">
          <h2 class="title" style="margin:0">Sem metas ainda</h2>
          <div class="sub">Crie ‚ÄúPC novo‚Äù, ‚ÄúCarro‚Äù, ‚ÄúReserva‚Äù‚Ä¶ e acompanhe o progresso.</div>
          <div style="margin-top:12px"><button class="btnGood" onclick="openModal('goal')">+ Criar meta</button></div>
        </div>
      `}
    </div>
  `;
}

function renderBudget(){
  const spend = spendingByCategory(selectedMonth);
  const rows = state.categorias.map(cat=>{
    const gasto = Number(spend[cat]||0);
    const lim = Number(state.orcamento?.[cat]||0);
    const pct = lim>0 ? gasto/lim : null;
    const status = lim>0 ? (pct>=1?"Estourou":pct>=0.8?"Aten√ß√£o":"Ok") : "Sem limite";
    const cls = lim>0 ? (pct>=1?"bad":pct>=0.8?"warn":"good") : "muted";
    return {cat,gasto,lim,status,cls};
  }).sort((a,b)=>b.gasto-a.gasto);

  budget.innerHTML = `
    <div class="split" style="margin-bottom:12px">
      <div>
        <h2 class="title" style="margin:0">Or√ßamento</h2>
        <div class="sub">Defina limites por categoria pra ‚Äúamenizar‚Äù os vazamentos.</div>
      </div>
      <button class="btnWarn" onclick="openModal('budget')">+ Definir limite</button>
    </div>
    <div class="card">
      <table>
        <tr><th>Categoria</th><th>Gasto</th><th>Limite</th><th>Faltando</th><th>Status</th></tr>
        ${rows.map(r=>{
          const falt = r.lim>0 ? Math.max(0, r.lim-r.gasto) : null;
          return `
            <tr>
              <td>${r.cat}</td>
              <td class="bad">${money(r.gasto)}</td>
              <td>${r.lim>0?money(r.lim):"‚Äî"}</td>
              <td>${r.lim>0?money(falt):"‚Äî"}</td>
              <td class="${r.cls}">${r.status}</td>
            </tr>
          `;
        }).join("")}
      </table>
    </div>
  `;
}

function renderFixed(){
  const list = [...state.fixos].sort((a,b)=>a.dia-b.dia);

  fixed.innerHTML = `
    <div class="split" style="margin-bottom:12px">
      <div>
        <h2 class="title" style="margin:0">Contas fixas</h2>
        <div class="sub">Internet, academia, assinaturas‚Ä¶ voc√™ edita e pausa quando quiser.</div>
      </div>
      <button onclick="openModal('fixed')" class="btnPrimary">+ Conta fixa</button>
    </div>

    <div class="card">
      <table>
        <tr><th>Conta</th><th>Categoria</th><th>Venc.</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr>
        ${list.map(f=>`
          <tr>
            <td>${f.nome}</td>
            <td><span class="tag">${f.categoria}</span></td>
            <td>Dia ${f.dia}</td>
            <td class="bad">${money(f.valor)}</td>
            <td>${f.ativa ? `<span class="tag"><span class="dot" style="background:var(--good)"></span> Ativa</span>` : `<span class="tag"><span class="dot" style="background:var(--muted)"></span> Pausada</span>`}</td>
            <td style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btnGhost" onclick="toggleFixed('${f.id}')">${f.ativa?"Pausar":"Ativar"}</button>
              <button onclick="editFixed('${f.id}')">Editar</button>
              <button class="btnBad" onclick="delFixed('${f.id}')">Excluir</button>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="muted">Nenhuma conta fixa cadastrada.</td></tr>`}
      </table>
    </div>
  `;
}

function renderCards(){
  const list = monthCard(selectedMonth);
  const totalMes = sum(list);
  const groups = getCardGroupsForMonth(selectedMonth);

  cards.innerHTML = `
    <div class="split" style="margin-bottom:12px">
      <div>
        <h2 class="title" style="margin:0">Cart√£o / Fatura</h2>
        <div class="sub">Fatura do m√™s com parcelas. Voc√™ pode editar ou excluir a compra inteira.</div>
      </div>
      <button class="btnPrimary" onclick="openModal('tx', {tipo:'cartao', meio:'Cr√©dito', parcelas:1})">+ Compra no cart√£o</button>
    </div>

    <div class="grid">
      <div class="card span4">
        <div class="label">Total da fatura (m√™s)</div>
        <div class="value bad">${money(totalMes)}</div>
        <div class="sub">Somat√≥rio das parcelas deste m√™s</div>
      </div>

      <div class="card span8">
        <div class="split">
          <div>
            <div class="label">Compras que aparecem no m√™s</div>
            <div class="sub">Agrupadas por compra</div>
          </div>
        </div>

        <table style="margin-top:10px">
          <tr><th>Compra</th><th>Categoria</th><th>Parcelas</th><th>Parcela no m√™s</th><th>A√ß√µes</th></tr>
          ${groups.map(g=>{
            const p = g.parcelasNoMes[0];
            const parcelaMes = `${p.parcela} ‚Ä¢ ${money(p.valor)}`;
            return `
              <tr>
                <td>${g.desc}</td>
                <td><span class="tag">${g.categoria || "Outros"}</span></td>
                <td>${g.parcelas}x ‚Ä¢ Total ${money(g.total)}</td>
                <td class="bad">${parcelaMes}</td>
                <td style="display:flex;gap:8px;flex-wrap:wrap">
                  <button onclick="editCardPurchase('${g.groupId}')">Editar</button>
                  <button class="btnBad" onclick="delCardPurchase('${g.groupId}')">Excluir</button>
                </td>
              </tr>
            `;
          }).join("") || `<tr><td colspan="5" class="muted">Sem parcelas neste m√™s.</td></tr>`}
        </table>
      </div>

      <div class="card span12">
        <div class="split">
          <div>
            <h3 class="title" style="margin:0">Parcelas do m√™s (detalhado)</h3>
            <div class="sub">Tudo que comp√µe a fatura deste m√™s</div>
          </div>
        </div>
        <table style="margin-top:10px">
          <tr><th>Descri√ß√£o</th><th>Categoria</th><th>Parcela</th><th>Valor</th></tr>
          ${list.map(p=>`
            <tr>
              <td>${p.desc}</td>
              <td><span class="tag">${p.categoria || "Outros"}</span></td>
              <td>${p.parcela}</td>
              <td class="bad">${money(p.valor)}</td>
            </tr>
          `).join("") || `<tr><td colspan="4" class="muted">Sem parcelas neste m√™s.</td></tr>`}
        </table>
      </div>
    </div>
  `;
}

function renderTx(){
  const txList = [...monthTx(selectedMonth)].sort((a,b)=>a.data.localeCompare(b.data));
  const t = totalsForMonth(selectedMonth);

  tx.innerHTML = `
    <div class="split" style="margin-bottom:12px">
      <div>
        <h2 class="title" style="margin:0">Lan√ßamentos</h2>
        <div class="sub">Entradas/sa√≠das do m√™s. Aqui voc√™ edita e exclui quando quiser.</div>
      </div>
      <button class="btnPrimary" onclick="openModal('tx')">+ Lan√ßamento</button>
    </div>

    <div class="grid">
      <div class="card span6">
        <div class="label">Entradas do m√™s</div>
        <div class="value good">${money(t.entradas)}</div>
      </div>
      <div class="card span6">
        <div class="label">Sa√≠das do m√™s</div>
        <div class="value bad">${money(t.saidas)}</div>
      </div>

      <div class="card span12">
        <table>
          <tr><th>Data</th><th>Tipo</th><th>Meio</th><th>Categoria</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr>
          ${txList.map(x=>`
            <tr>
              <td>${x.data}</td>
              <td><span class="tag">${x.tipo}</span></td>
              <td>${x.meio}</td>
              <td><span class="tag">${x.categoria || "Outros"}</span></td>
              <td>${x.desc}</td>
              <td class="${x.tipo==='entrada'?'good':'bad'}">${money(x.valor)}</td>
              <td style="display:flex;gap:8px;flex-wrap:wrap">
                <button onclick="editTx('${x.id}')">Editar</button>
                <button class="btnBad" onclick="delTx('${x.id}')">Excluir</button>
              </td>
            </tr>
          `).join("") || `<tr><td colspan="7" class="muted">Sem lan√ßamentos neste m√™s.</td></tr>`}
        </table>
      </div>
    </div>
  `;
}

function render(){
  renderTop();

  // se m√™s j√° estiver fechado, desabilita o bot√£o ‚ÄúFechar m√™s‚Äù (visual)
  const closeBtn = Array.from(document.querySelectorAll("button")).find(b => (b.textContent||"").includes("Fechar m√™s"));
  if(closeBtn){
    closeBtn.disabled = isMonthClosed(selectedMonth);
    closeBtn.style.opacity = closeBtn.disabled ? 0.5 : 1;
    closeBtn.style.cursor = closeBtn.disabled ? "not-allowed" : "pointer";
  }

  if(view==="overview") renderOverview();
  if(view==="goals") renderGoals();
  if(view==="budget") renderBudget();
  if(view==="fixed") renderFixed();
  if(view==="cards") renderCards();
  if(view==="tx") renderTx();
}

/* init */
render();
</script>
</body>
</html>
